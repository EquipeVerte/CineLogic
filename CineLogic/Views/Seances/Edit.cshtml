@model CineLogic.Business.Programmation.SeanceEditionViewModel

@section css {
    @Styles.Render("~/Content/programmation.css")
}

@{
    ViewBag.Title = "Édition";
}

<h2>Édition : Séance @Model.SeanceID - @Model.Titre</h2>

<div class="form-group">
    <div class="col-md-10">
        <a href="@Url.Action("Index")" class="btn btn-outline-primary"><i class="fas fa-chevron-left"></i> Rétourner au calendrier</a>
    </div>
</div>

<hr />

<!-- Alert de changements non-enregistrés -->
@if (ViewBag.UnsavedChanges != null)
{
    <div class="alert alert-danger" id="unsaved-alert">
        <div class="row">
            <div class="col-md-10  d-flex justify-content-start align-items-center">
                <h5><i class="fas fa-exclamation-triangle"></i> Vous avez des changements non-enregistrés.</h5>
            </div>
            <div class="col-md-2 d-flex justify-content-end align-items-center">
                <button class="btn btn-danger mr-2" id="annuler-changes">Annuler</button>
                <button class="btn btn-success" id="save-changes">Enregistrer</button>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-danger collapse" id="unsaved-alert">
        <div class="row">
            <div class="col-md-10  d-flex justify-content-start align-items-center">
                <h5><i class="fas fa-exclamation-triangle"></i> Vous avez des changements non-enregistrés.</h5>
            </div>
            <div class="col-md-2 d-flex justify-content-end align-items-center">
                <button class="btn btn-danger mr-2" id="annuler-changes">Annuler</button>
                <button class="btn btn-success" id="save-changes">Enregistrer</button>
            </div>
        </div>
    </div>
}

<div class="row">
    <div class="col-md-6">
        <!-- Formulaire d'édition de la séance-->
        @using (Html.BeginForm("Edit", "Seances", FormMethod.Post, new { name = "edit", id = "edit" }))
        {
            @Html.AntiForgeryToken()

            <div class="form-horizontal">
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                @Html.HiddenFor(model => model.SeanceID)
                @Html.HiddenFor(model => model.SalleID)

                <div class="form-group">
                    @Html.LabelFor(model => model.Titre, htmlAttributes: new { @class = "control-label col" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.Titre, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.Titre, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.HeureDebut, htmlAttributes: new { @class = "control-label col" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.HeureDebut, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.HeureDebut, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.HeureFin, htmlAttributes: new { @class = "control-label col" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.HeureFin, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.HeureFin, "", new { @class = "text-danger" })
                    </div>
                </div>

                @if (ViewBag.ScheduleError != null)
                {
                    <div class="form-group">
                        <div class="alert alert-danger alert-dismissible fade show">
                            <h3>Erreur!</h3>
                            <p>@ViewBag.ScheduleError</p>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    </div>
                }
                @if (ViewBag.Success != null)
                {
                    <div class="form-group">
                        <div class="alert alert-success alert-dismissible fade show">
                            <h3>Succès!</h3>
                            <p>La séance à été mis à jour avec succès</p>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Formulaire de suppression pour la séance-->
        @using (Html.BeginForm("Delete", "Seances", FormMethod.Post, new { name = "delete", id = "delete" }))
        {
            <div class="form-group">
                @Html.HiddenFor(model => model.SeanceID)
            </div>
        }

        <!-- Boutons de soumission pour les formulaires-->
        <div class="form-group">
            <div class="col-md-10">
                <input type="submit" value="Supprimer" class="btn btn-outline-danger mr-3" form="delete" />
                <input type="submit" value="Actualiser" class="btn btn-outline-success" form="edit" />
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <!-- Selection et boit de récherche pour les films
        <div class="form-group">

            @Html.LabelFor(model => model.ContenuTitre, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.TextBoxFor(model => model.ContenuTitre, new { @class = "form-control mb-1", @readonly = "readonly", @placeholder = "Aucun contenu assigné encore" })
            </div>
            <div class="col-md-10">
                <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#filmSelection">
                    Selectionner un film
                </button>
            </div>
        </div>-->
        <ul class="list-group" id="list-films">
            @*@foreach (var film in Model.Contenus)
                {*@
            <li class="list-group-item d-flex align-items-center" id="1">
                <h3>Film 1</h3>
                <div class="ml-auto d-flex flex-column justify-content-between">
                    <div onclick="moveup(1)" class="btn-order">
                        <i class="fas fa-chevron-up"></i>
                    </div>
                    <div onclick="movedown(1)" class="btn-order">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </li>
            <li class="list-group-item d-flex align-items-center" id="2">
                <h3>Film 2</h3>
                <div class="ml-auto d-flex flex-column justify-content-between">
                    <div class="btn-order">
                        <i class="fas fa-chevron-up"></i>
                    </div>
                    <div class="btn-order">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </li>
            @*}*@
        </ul>
        <button class="btn btn-outline-success" onclick="getOrder()">Get order</button>
    </div>
</div>

@section modals {
    <div class="modal fade" id="filmSelection" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Selectionner un film</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Recherchez un film et sélectionnez-le dans la liste ci-dessous.</p>
                    <p>Pour retirer un film, sélectionner N/A.</p>
                    <div class="form-group">
                        <input id="filter" class="form-control mb-1" placeholder="Recherche" />
                        <div class="d-flex justify-content-center">
                            <div id="loading" class="pl-2">
                                <div class="loader-small">
                                    <i class="fas fa-film"></i>
                                </div>
                            </div>
                        </div>
                        <select id="film-select" class="form-control mr-2" size="6">
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@section scripts {

    <script type="text/javascript">
        $(document).ready(function () {
            $("#save-changes").on('click', function () {
                console.log("save changes clicked");
                var jqxhr = $.get("@Url.Action("Save")", function (data) {
                    console.log("hide");
                    $("#unsaved-alert").hide();
                });
            });

            $("#annuler-changes").on('click', function () {
                $.get("@Url.Action("Annuler")", function (data) {
                    $("#unsaved-alert").hide();
                });
            });
        });
    </script>
    <script>
        $(document).ready(function () {

            getFilms();

            //  Mettre à jour les films à chaque changement dans la boite de recherche.
            //  Est-ce que l'ajax est néccesaire? Peut être fais en javascript avec une liste statique?
            $("#filter").on('input', function () {
                console.log("Change");
                getFilms();
            });

            function getFilms() {
                $.get("@Url.Action("Contenus", "Contenus")", { filter: $("#filter").val() }, function (data) {
                    $("#film-select").empty();
                    $("#film-select").append('<option value="">N/A</option>');
                    $.each(data, function (i, item) {
                        $("#film-select").append('<option value="' + item + '">' + item + '</option>');
                    });
                });
            }

            $("#film-select").on('change', function () {
                $("#ContenuTitre").val($("#film-select").val());
            });
        })
            .ajaxStart(function () {
                console.log("ajax start");
                $("#loading").show();
            })
            .ajaxStop(function () {
                console.log("ajax stop");
                $("#loading").hide();
            });


    </script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        var el = document.getElementById('list-films');
        var sortable = Sortable.create(el);

        function getOrder() {
            var order = [];

            $('#list-films').children('.list-group-item').each(function (i, item) {
                order.push(item.id);
            });

            console.log(order);
        }
    </script>
}
